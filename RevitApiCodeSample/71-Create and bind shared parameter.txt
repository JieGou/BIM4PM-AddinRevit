 #region Lab4_3_1_CreateAndBindSharedParam
  /// <summary>
  /// Create and bind shared parameter.
  /// </summary>
  [Transaction( TransactionMode.Manual )]
  public class Lab4_3_1_CreateAndBindSharedParam : IExternalCommand
  {
    // What element type are we interested in? 
    // The standard SDK FireRating sample uses BuiltInCategory.OST_Doors. 
    // We also test using BuiltInCategory.OST_Walls to demonstrate that the same technique
    // works with system families just as well as with standard ones.
    //
    // To test attaching shared parameters to inserted DWG files,
    // which generate their own category on the fly, we also identify
    // the category by category name.
    //
    // Further tests confirm the possibility to attach 
    // shared parameters to model groups, model lines, 
    // rectangular straight wall openings and material 
    // elements.

    static public BuiltInCategory Target = BuiltInCategory.OST_Doors;
    //static public BuiltInCategory Target = BuiltInCategory.OST_Walls;
    //static public string Target = "Drawing1.dwg";
    //static public BuiltInCategory Target = BuiltInCategory.OST_IOSModelGroups; // doc.Settings.Categories.get_Item returns null
    //static public string Target = "Model Groups"; // doc.Settings.Categories.get_Item throws an exception SystemInvalidOperationException "Operation is not valid due to the current state of the object."
    //static public BuiltInCategory Target = BuiltInCategory.OST_Lines; // model lines
    //static public BuiltInCategory Target = BuiltInCategory.OST_SWallRectOpening; // Rectangular Straight Wall Openings, case 1260656 [Add Parameters Wall Opening]
    //static public BuiltInCategory Target = BuiltInCategory.OST_Materials; // can I attach a shared parameter to a material element? Yes, absolutely, no problem at all.

    public Result Execute(
      ExternalCommandData commandData,
      ref string message,
      ElementSet elements )
    {
      UIApplication uiapp = commandData.Application;
      Application app = uiapp.Application;
      Document doc = uiapp.ActiveUIDocument.Document;
      Category cat = null;

      #region Determine model group category
#if DETERMINE_MODEL_GROUP_CATEGORY
      List<Element> modelGroups = new List<Element>();
      //Filter fType = app.Create.Filter.NewTypeFilter( typeof( Group ) ); // "Binding the parameter to the category Model Groups is not allowed"
      Filter fType = app.Create.Filter.NewTypeFilter( typeof( GroupType ) ); // same result "Binding the parameter to the category Model Groups is not allowed"
      Filter fCategory = app.Create.Filter.NewCategoryFilter( BuiltInCategory.OST_IOSModelGroups );
      Filter f = app.Create.Filter.NewLogicAndFilter( fType, fCategory );
      if ( 0 < doc.get_Elements( f, modelGroups ) )
      {
        cat = modelGroups[0].Category;
      }
#endif // DETERMINE_MODEL_GROUP_CATEGORY
      #endregion // Determine model group category

      if( null == cat )
      {
        // The category we are defining the parameter for

        try
        {
          cat = doc.Settings.Categories.get_Item( Target );
        }
        catch( Exception ex )
        {
          message = "Error obtaining the shared param document category: "
            + ex.Message;
          return Result.Failed;
        }
        if( null == cat )
        {
          message = "Unable to obtain the shared param document category.";
          return Result.Failed;
        }
      }

      // Get the current shared params definition file

      DefinitionFile sharedParamsFile = LabUtils.GetSharedParamsFile( app );
      if( null == sharedParamsFile )
      {
        message = "Error getting the shared params file.";
        return Result.Failed;
      }

      // Get or create the shared params group

      DefinitionGroup sharedParamsGroup 
        = LabUtils.GetOrCreateSharedParamsGroup(
          sharedParamsFile, LabConstants.SharedParamsGroupAPI );

      if( null == sharedParamsGroup )
      {
        message = "Error getting the shared params group.";
        return Result.Failed;
      }

      // Visibility of the new parameter: the 
      // Category.AllowsBoundParameters property 
      // determines whether a category is allowed to
      // have user-visible shared or project parameters. 
      // If it is false, it may not be bound to visible
      // shared parameters using the BindingMap. Note 
      // that non-user-visible parameters can still be 
      // bound to these categories.

      bool visible = cat.AllowsBoundParameters;

      // Get or create the shared params definition

      Definition fireRatingParamDef 
        = LabUtils.GetOrCreateSharedParamsDefinition(
          sharedParamsGroup, ParameterType.Number, 
          LabConstants.SharedParamsDefFireRating, visible );

      if( null == fireRatingParamDef )
      {
        message = "Error in creating shared parameter.";
        return Result.Failed;
      }

      // Create the category set for binding and add the category
      // we are interested in, doors or walls or whatever:

      CategorySet catSet = app.Create.NewCategorySet();
      try
      {
        catSet.Insert( cat );
      }
      catch( Exception )
      {
        message = string.Format(
          "Error adding '{0}' category to parameters binding set.",
          cat.Name );
        return Result.Failed;
      }

      // Bind the parameter.

      try
      {
        using( Transaction t = new Transaction( doc ) )
        {
          t.Start( "Bind Fire Rating Shared Parameter" );

          Binding binding = app.Create.NewInstanceBinding( catSet );

          // We could check if already bound, but looks 
          // like Insert will just ignore it in that case.

          doc.ParameterBindings.Insert( fireRatingParamDef, binding );

          // You can also specify the parameter group here:

          //doc.ParameterBindings.Insert( fireRatingParamDef, binding, BuiltInParameterGroup.PG_GEOMETRY );

          t.Commit();
        }
      }
      catch( Exception ex )
      {
        message = ex.Message;
        return Result.Failed;
      }
      return Result.Succeeded;
    }
  }
  #endregion // Lab4_3_1_CreateAndBindSharedParam